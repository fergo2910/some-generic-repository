name: tag to issue

on:
  push:
    tags:
      - test*

jobs:
  start_promotion_pipeline:
    runs-on: ubuntu-latest
    steps:
      - name: Check if a new promotion pipeline already exists
        run: |
          issues=$(curl -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{github.token}}" \
          https://api.github.com/repos/${{github.repository}}/issues?labels=promotion-pipeline&state=open | jq '.[]?.number')
          if [[ "$issues" == "" ]];
          then
            echo "No promotion pipeline created."
          else
            echo "One or more promotion pipelines are open. Close them first to create a new one"
            for i in $issues;
            do
              echo "https://github.com/${{github.repository}}/issues/$i"
            done
            exit 1;
          fi
      - name: Create issue with pipeline details
        run: |
          curl -X POST -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{github.token}}" https://api.github.com/repos/${{github.repository}}/issues \
          -d '{"title":"Artifact Promotion","body":"New promotion pipeline created for tag ${{github.ref}}","assignees":["fergo2910"],"labels":["promotion-pipeline"]}'